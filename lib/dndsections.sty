\ExplSyntaxOn

\ifpkglayout

\RequirePackage[titles]{tocloft}
\RequirePackage{titlesec}	% Used to adjust (sub)section formatting

\iftoggle{multitoc}{%
  \RequirePackage[toc]{multitoc}
}{}

%Remove Numbering (If you want Numbering set secnumdepth to the appropriate depth)
\setcounter{secnumdepth}{-1}

% Chapter
\titleformat{\chapter}
{\color{titlered}\l__dnd_font_title_tl\Huge}{\thechapter\quad}{0pt}{}

\titlespacing*{\chapter}{0pt}{0pt}{20pt}

\ifdef{\cftchapfont}{%
  \renewcommand\cftchapfont{\color{titlered}\l__dnd_font_title_tl\bfseries}
}{}

% Section
\titleformat{\section}
{\color{titlered}\l__dnd_font_title_tl\LARGE\RaggedRight}{\thesection\quad}{0pt}{\nopagebreak}

% Subsection
\titleformat{\subsection}
{\color{titlered}\l__dnd_font_title_tl\Large\RaggedRight}{\thesubsection\quad}{0pt}{\nopagebreak}
[\titleline{\color{titlegold}\titlerule[1pt]}]

% Subsubsection
\titleformat{\subsubsection}
{\color{titlered}\l__dnd_font_title_tl\large\RaggedRight}{\thesubsubsection\quad}{0pt}{\nopagebreak}[]

% Paragraph
\titleformat{\paragraph}[runin]
{\normalfont\normalsize\bfseries\slshape}{\theparagraph\quad}{0pt}{}[.]
\titlespacing*{\paragraph}
{0pt}{\parskip}{\wordsep}

% Subparagraph
\titleformat{\subparagraph}[runin]
{\normalfont\normalsize\bfseries\slshape}{\thesubparagraph\quad}{0pt}{}[.]
\titlespacing*{\subparagraph}
{\parindent}{\parskip}{\wordsep}

\fi % \ifpkglayout
\ExplSyntaxOff
% Special command for magic items, traps, and the like.
\newcommand{\subtitlesection}[2]{
	\subsubsection{#1}\vspace{-1ex}
	\textit{#2}\vspace{1ex}\par
	} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Map Areas and their References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Labelling helpers
\newcommand{\AreaLabel@Prefix}{area}
\newcommand{\SetAreaLabelPrefix}[1]{%
  \renewcommand{\AreaLabel@Prefix}{#1}}

\newcounter{Area}
\newcommand\ResetAreas{%
  \setcounter{Area}{0}}

\NewDocumentCommand\area{mo}{%
  \refstepcounter{Area}%
  \IfNoValueTF{#2}%
    {\label{\AreaLabel@Prefix:#1}}%
    {\label{\AreaLabel@Prefix:#2}}%
  \subsection{\arabic{Area}. #1}%
}

% defines sub-areas, like '5a', '5b'
\newcounter{SubArea}[Area]

\NewDocumentCommand\subarea{mo}{%
  \refstepcounter{SubArea}%
  \IfNoValueTF{#2}%
    {\label{\AreaLabel@Prefix:#1}}%
    {\label{\AreaLabel@Prefix:#2}}%
  \subsubsection{\arabic{Area}\alph{SubArea}. #1}%
}

% sub area references should be '5a', '5b', not '1', '2'
\renewcommand\p@SubArea{\arabic{Area}}
\renewcommand\theSubArea{\alph{SubArea}}

\newcounter{DetailArea}[subsection]
\newcommand{\DetailArea@Prefix}{}
\newcommand{\SetDetailAreaPrefix}[1]{\renewcommand{\DetailArea@Prefix}
      {#1--\arabic{DetailArea}\par\expandafter\ignorespaces\noindent}}

