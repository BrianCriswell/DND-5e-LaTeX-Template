\ExplSyntaxOn

\ifpkglayout

% Remove Numbering (If you want Numbering set secnumdepth to the appropriate depth)
\setcounter { secnumdepth } { -1 }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Section formatting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Chapter
\titleformat { \chapter }
  { \dnd@TitleFont \Huge \color { titlered } } % format
  { \thechapter \quad } % label
  { 0pt } % sep
  {} % before-code

\titlespacing* { \chapter }
  { 0pt } % left
  { 0pt } % before-sep
  { 1.5ex } % after-sep

%\ifdef{\cftchapfont}{%
%  \renewcommand \cftchapfont { \color { titlered } \dnd@TitleFont \bfseries }
%}{}

% Section
\titleformat { \section }
  { \dnd@TitleFont \LARGE \color { titlered } } % format
  { \thesection \quad } % label
  { 0pt } % sep
  { \RaggedRight \setstretch{.8} \nopagebreak  } % before-code
  [ \smallskip ] % after-code

\titlespacing* { \section }
  { 0pt } % left
  { 1.5ex plus .2ex minus .2ex } % before-sep
  { 0pt } % after-sep

% Subsection
\titleformat{\subsection}
  { \dnd@TitleFont \Large \color { titlered } } % format
  { \thesubsection \quad } % label
  { 0pt } % sep
  { \RaggedRight \setstretch{.8} \nopagebreak } % before-code
  [ \vspace { -.3ex } \titleline { \color { titlegold } \titlerule [ 1pt ] } ] % after-code

\titlespacing*{ \subsection }
  { 0pt } % left
  { 1.6ex } % before-sep
  { .75ex } % after-sep

% Subsubsection
\titleformat{\subsubsection}
  { \dnd@TitleFont \large \color { titlered } } % format
  { \thesubsubsection \quad } % label
  { 0pt } % sep
  { \RaggedRight \setstretch{.8} \nopagebreak } % before-code

\titlespacing* { \subsubsection }
  { 0pt } % left
  { 1.7ex plus .2ex minus .2ex } % before-sep
  { 0pt } % after-sep

% Paragraph
\titleformat{\paragraph}[runin]
  { \normalfont \normalsize \bfseries \slshape } % format
  { \theparagraph \quad } % label
  { 0pt } % sep
  {} % before-code
  [.] % after-code

\titlespacing*{\paragraph}
  { 0pt } % left
  { \parskip } % before-sep
  { \wordsep } % after-sep

% Subparagraph
\titleformat { \subparagraph } [ runin ]
  { \normalfont \normalsize \bfseries \slshape } % format
  { \thesubparagraph \quad } % label
  { 0pt } % sep
  {} % before-code
  [.] % after-code

\titlespacing* { \subparagraph }
  { \parindent } % left
  { \parskip } % before-sep
  { \wordsep } % after-sep

\fi % \ifpkglayout

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Special command for magic items, traps, and the like.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\NewDocumentCommand { \DndItemHeader } { m m }
  {
    \subsubsection{#1}
    \textit{#2} \par \smallskip \noindent \ignorespaces
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Map Areas and their References
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Options
\keys_define:nn { dnd / areas }
  {
    area-label-prefix .tl_set:N          = \l__dnd_area_label_prefix_tl,
    area-label-prefix .initial:n         = area,
    area-label-prefix .value_required:n  = true,
    sub-area-label-prefix .tl_set:N          = \l__dnd_sub_area_label_prefix_tl,
    sub-area-label-prefix .initial:n         = subarea,
    sub-area-label-prefix .value_required:n  = true,
  }

\NewDocumentCommand { \DndSetAreaOptions } { o }
  {    
    \keys_set:nn { dnd / areas } { #1 }
  }

% Counters
\newcounter{DndAreaCounter}

\NewDocumentCommand { \DndResetAreas } {}
  {
    \setcounter { DndAreaCounter } { 0 }
  }

\newcounter { DndSubAreaCounter } [ DndAreaCounter ]

% sub area references should be '5a', '5b', not '51', '52'
\renewcommand \p@DndSubAreaCounter { \arabic { DndAreaCounter } }
\renewcommand \theDndSubAreaCounter { \alph { DndSubAreaCounter } }

% Functions to create an area including text and label
\NewDocumentCommand { \DndArea } { m }
  {
    \refstepcounter { DndAreaCounter }
    \label { \l__dnd_area_label_prefix_tl :#1 }
    \arabic{ DndAreaCounter } .~#1
  }

\NewDocumentCommand { \DndSubArea } { m }
  {
    \refstepcounter { DndSubAreaCounter }
    \label { \l__dnd_sub_area_label_prefix_tl :#1 }
    \arabic { DndAreaCounter } \alph { DndSubAreaCounter } .~#1
  }

% Functions to reference a label
\NewDocumentCommand { \DndAreaRef } { m }
  {
    #1~(\pageabbreviationname\ \pageref { \l__dnd_area_label_prefix_tl :#1 })
  }

\NewDocumentCommand { \DndSubAreaRef } { m }
  {
    #1~(\pageabbreviationname\ \pageref { \l__dnd_sub_area_label_prefix_tl :#1 })
  }

%\newcounter { DndDetailAreaCounter } [ subsection ]
%\newcommand { \DetailArea@Prefix } {}
%\newcommand { \SetDetailAreaPrefix } [ 1 ] { \renewcommand { \DetailArea@Prefix }
%      { #1 -- \arabic { DndDetailAreaCounter } \par \expandafter \ignorespaces \noindent } }

\ExplSyntaxOff