\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environment for inline comments.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareTColorBox { DndComment } { O { enhanced } m O { commentcolor } }
	{
		before~upper={
			\ifpkglayout
				\nottoggle {justified } { \RaggedRight }
			\fi
		},
		frame~hidden,
		boxrule = 0pt,
		breakable,
		enhanced,
		before~skip = 9pt plus 3pt minus 3pt,
		toptitle = 3mm,
		boxsep = 0.25ex,
		left = 8pt,
		right = 8pt,
		sharp~corners,
		fonttitle = \dnd@BoxTitleFont,
		fontupper = \dnd@BoxBodyFont,
		fontlower = \dnd@BoxBodyFont,
		title = {#2},
		parbox = false,
		colback = {#3},
		colbacktitle = {#3},
		coltitle = black,
		after~skip = 9pt plus 3pt minus 3pt,
		#1,
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environment for read aloud text.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareTColorBox { DndReadAloud } { O { enhanced~jigsaw } O { readaloudcolor } }
  {
    before~upper    =
      {
        \ifpkglayout
          \nottoggle { justified } { \RaggedRight }
        \fi
      },
    code            = { \linespread { 1.25 } },
    enhanced~jigsaw,
    frame~hidden,
    boxrule         = 0pt,
    breakable,
    enhanced,
    before~skip     = 12pt plus 4pt minus 4pt,
    boxsep          = 0.25ex,
    left            = 8pt,
    right           = 8pt,
    colback         = #2,
    sharp~corners,
    parbox          = false,
    borderline~west = { 1pt } { -0.5pt } { titlered },
    borderline~east = { 1pt } { -0.5pt } { titlered },
    fontupper       = \dnd@BoxBodyFont,
    fontlower       = \dnd@BoxBodyFont,
    overlay         =
      {
        \foreach\n~in~{north~east,north~west,south~east,south~west}
        {\draw[titlered, fill=titlered] (frame.\n) circle (2pt); };
      },
    after~skip      = 12pt plus 4pt minus 4pt,
    #1,
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environment for sidebars.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DeclareTColorBox { DndSidebar } { O { enhanced } m O { sidebarcolor } }
	{
    before~upper     =
      {
        \ifpkglayout
          \nottoggle { justified } { \RaggedRight }
        \fi
		  },
		frame~hidden,
		boxrule          = 0pt,
		enhanced,
		before~skip      = 14pt plus 3pt minus 3pt,
		toptitle         = 3mm,
		boxsep           = 0.25ex,
		left             = 8pt,
		right            = 8pt,
		fonttitle        = \dnd@BoxTitleFont,
		fontupper        = \dnd@BoxBodyFont,
		fontlower        = \dnd@BoxBodyFont,
		title            = {#2},
		sharp~corners,
		parbox           = false,
		borderline~north = {1pt}{-0.5pt}{black},
		borderline~south = {1pt}{-0.5pt}{black},
		colback          = {#3},
		colbacktitle     = {#3},
		coltitle         = black,
		fuzzy~shadow     = {0mm}{-3.5pt}{-0.5pt}{0.4mm}{black!60!white},
    overlay          =
      {
        \fill[black] (frame.south~west) -- ++ (7pt,0) -- ++ (0,-5pt) -- cycle;
        \fill[black] (frame.north~west) -- ++ (7pt,0) -- ++ (0,5pt) -- cycle;
        \fill[black] (frame.north~east) -- ++ (-7pt,0) -- ++ (0,5pt) -- cycle;
        \fill[black] (frame.south~east) -- ++ (-7pt,0) -- ++ (0,-5pt) -- cycle;
			},
		after~skip=14pt plus 3pt minus 3pt,
		#1,
	}

\ExplSyntaxOff